#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "ğŸ” ë¸Œëœì¹˜ ì´ë¦„ ê²€ì‚¬ ë° GitHub Projects ìƒíƒœ ìë™í™” ì‹œì‘"

# ğŸ” .env ë¡œë“œ (.git ë£¨íŠ¸ ê¸°ì¤€)
ROOT_DIR=$(git rev-parse --show-toplevel)
ENV_FILE="$ROOT_DIR/.env"

if [ -f "$ENV_FILE" ]; then
  export $(grep -v '^#' "$ENV_FILE" | xargs)
  echo "ğŸ” .env íŒŒì¼ ë¡œë“œ ì™„ë£Œ"
else
  echo "âš ï¸ .env íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $ENV_FILE"
fi

# GITHUB_PAT í™•ì¸
if [ -z "$GITHUB_PAT" ]; then
  echo "âŒ GITHUB_PAT í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”."
  exit 1
fi

BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)

# ì˜ˆì™¸ ë¸Œëœì¹˜ (ê²€ì‚¬ ì œì™¸)
if echo "$BRANCH_NAME" | grep -Eq '^(main|develop|release.*)$'; then
  echo "â„¹ï¸ ì‹œìŠ¤í…œ ë¸Œëœì¹˜('$BRANCH_NAME')ëŠ” ë„¤ì´ë° ì²´í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
  exit 0
fi

# ë¸Œëœì¹˜ ë„¤ì´ë° ê·œì¹™
BRANCH_REGEX="^(feature|fix|hotfix|release|refactor|chore|docs)#[0-9]+/[a-z0-9\-]+$"

if ! echo "$BRANCH_NAME" | grep -Eq "$BRANCH_REGEX"; then
  echo "âš ï¸ ë¸Œëœì¹˜ ì´ë¦„ ê·œì¹™ ìœ„ë°˜: '$BRANCH_NAME'"
  echo "   âœ… ì˜ˆì‹œ: feature#123/login-api, fix#456/null-check, refactor#789/refine-logic"
  exit 0  # checkoutì€ í—ˆìš©, ë‹¨ ê²½ê³ ë§Œ ì¶œë ¥
fi

echo "âœ… ë¸Œëœì¹˜ ì´ë¦„ ê·œì¹™ í†µê³¼: '$BRANCH_NAME'"

# ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '#[0-9]+' | tr -d '#')

# GitHub Actions íŠ¸ë¦¬ê±°
echo ""
echo "ğŸ” ì—°ê²°ëœ ì´ìŠˆ(#${ISSUE_NUMBER})ë¥¼ GitHub Projectsì—ì„œ 'In Progress'ë¡œ ì´ë™ ì¤‘..."

# curl ì‘ë‹µ ë³¸ë¬¸ê³¼ HTTP ìƒíƒœì½”ë“œ ì¶”ì¶œ
response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
  -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $GITHUB_PAT" \
  https://api.github.com/repos/TEAM-JJINS/cs-algo/actions/workflows/on-branch-create.yml/dispatches \
  -d "{\"ref\":\"main\", \"inputs\":{\"branch\":\"$BRANCH_NAME\",\"issue\":\"$ISSUE_NUMBER\"}}")

# ì‘ë‹µ íŒŒì‹±
body=$(echo "$response" | sed -e 's/HTTP_STATUS\:.*//g')
status=$(echo "$response" | tr -d '\n' | sed -e 's/.*HTTP_STATUS://')

if [ "$status" -eq 204 ]; then
  echo "âœ… ì´ìŠˆ #${ISSUE_NUMBER}ì˜ ìƒíƒœê°€ 'In Progress'ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (GitHub Actions ì—°ë™)"
else
  echo "âŒ GitHub Actions íŠ¸ë¦¬ê±° ì‹¤íŒ¨ (HTTP $status)"
  echo "ğŸ“„ ì‘ë‹µ ë‚´ìš©: $body"
fi
