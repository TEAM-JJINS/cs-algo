---
# âœ… on-branch-create.yml (ë¸Œëœì¹˜ ìƒì„± ì‹œ In Progress ì „ì´)

name: On Branch Created

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë¸Œëœì¹˜ëª… (ì˜ˆ: feature#123/login-api)'
        required: true
      issue:
        description: 'ì—°ê²°ëœ ì´ìŠˆ ë²ˆí˜¸ (ì˜ˆ: 123)'
        required: true

jobs:
  move-issue-to-in-progress:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… ì…ë ¥ê°’ ì¶œë ¥
        run: |
          echo "ğŸ“¦ ë¸Œëœì¹˜ëª…: ${{ github.event.inputs.branch }}"
          echo "ğŸ”— ì´ìŠˆ ë²ˆí˜¸: #${{ github.event.inputs.issue }}"

      - name: ğŸ”„ GitHub Projects ìƒíƒœë¥¼ In Progressë¡œ ë³€ê²½
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue }}
          REPO=cs-algo
          OWNER=TEAM-JJINS
          PROJECT_NUMBER=1

          # ì´ìŠˆ ID ì¡°íšŒ
          ISSUE_ID=$(gh api graphql -f query="query { repository(owner: \"$OWNER\", name: \"$REPO\") { issue(number: $ISSUE_NUMBER) { id } } }" --jq '.data.repository.issue.id')
          if [ -z "$ISSUE_ID" ]; then
            echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœ ì „ì´ ìƒëµ."
            exit 0
          fi

          # í”„ë¡œì íŠ¸ ID ì¡°íšŒ
          PROJECT_ID=$(gh api graphql -f query="query { organization(login: \"$OWNER\") { projectV2(number: $PROJECT_NUMBER) { id } } }" --jq '.data.organization.projectV2.id')

          # itemId ì¡°íšŒ (í˜ì´ì§€ë„¤ì´ì…˜)
          ITEM_ID=""
          CURSOR=null
          while true; do
            if [ "$CURSOR" = "null" ]; then
              QUERY_ARG='first: 100'
            else
              QUERY_ARG="first: 100, after: \"$CURSOR\""
            fi

            RESPONSE=$(gh api graphql -f query="query { organization(login: \"$OWNER\") { projectV2(number: $PROJECT_NUMBER) { items($QUERY_ARG) { pageInfo { endCursor hasNextPage } nodes { id content { ... on Issue { number } } } } } } }")

            ITEM_ID=$(echo "$RESPONSE" | jq -r --argjson issue "$ISSUE_NUMBER" '.data.organization.projectV2.items.nodes[] | select(.content.number == $issue) | .id')
            if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then break; fi

            HAS_NEXT=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage')
            if [ "$HAS_NEXT" != "true" ]; then break; fi
            CURSOR=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.endCursor')
          done

          if [ -z "$ITEM_ID" ]; then
            echo "âš ï¸ í”„ë¡œì íŠ¸ì— í¬í•¨ë˜ì§€ ì•Šì€ ì´ìŠˆì…ë‹ˆë‹¤. ìƒíƒœ ì „ì´ ìƒëµ."
            exit 0
          fi

          # Status í•„ë“œ ë° In Progress ì˜µì…˜ ID ì¡°íšŒ
          STATUS_FIELD_ID=$(gh api graphql -f query="query { node(id: \"$PROJECT_ID\") { ... on ProjectV2 { fields(first: 20) { nodes { id name } } } } }" --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')
          IN_PROGRESS_OPTION_ID=$(gh api graphql -f query="query { node(id: \"$PROJECT_ID\") { ... on ProjectV2 { field(id: \"$STATUS_FIELD_ID\") { ... on ProjectV2SingleSelectField { options { id name } } } } } }" --jq '.data.node.field.options[] | select(.name=="In Progress") | .id')

          # ìƒíƒœ ì „ì´ ì‹¤í–‰
          gh api graphql -f query="mutation { updateProjectV2ItemFieldValue(input: { projectId: \"$PROJECT_ID\", itemId: \"$ITEM_ID\", fieldId: \"$STATUS_FIELD_ID\", value: { singleSelectOptionId: \"$IN_PROGRESS_OPTION_ID\" } }) { projectV2Item { id } } }"
          echo "âœ… ìƒíƒœ ì „ì´ ì™„ë£Œ: In Progress"