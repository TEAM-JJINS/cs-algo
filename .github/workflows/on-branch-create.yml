name: On Branch Created

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë¸Œëœì¹˜ëª… (ì˜ˆ: feature#123/login-api)'
        required: true
      issue:
        description: 'ì—°ê²°ëœ ì´ìŠˆ ë²ˆí˜¸ (ì˜ˆ: 123)'
        required: true

jobs:
  move-issue-to-in-progress:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… ì…ë ¥ê°’ ì¶œë ¥
        run: |
          echo "ğŸ“¦ ë¸Œëœì¹˜ëª…: ${{ github.event.inputs.branch }}"
          echo "ğŸ”— ì´ìŠˆ ë²ˆí˜¸: #${{ github.event.inputs.issue }}"

      - name: ğŸ”„ GitHub Projects ìƒíƒœë¥¼ 'In Progress'ë¡œ ë³€ê²½
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER=${{ github.event.inputs.issue }}
          REPO=cs-algo
          OWNER=TEAM-JJINS
          PROJECT_NUMBER=1

          # ì´ìŠˆ ID ì¡°íšŒ
          ISSUE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $issue: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issue) {
                  id
                }
              }
            }' -f owner="$OWNER" -f repo="$REPO" -F issue=$ISSUE_NUMBER --jq '.data.repository.issue.id')

          # í”„ë¡œì íŠ¸ ID ì¡°íšŒ
          PROJECT_ID=$(gh api graphql -f query='
            query {
              organization(login: "TEAM-JJINS") {
                projectV2(number: 1) {
                  id
                }
              }
            }' --jq '.data.organization.projectV2.id')

          # ì´ìŠˆë¥¼ í”„ë¡œì íŠ¸ì— ì¶”ê°€
          ITEM_ID=$(gh api graphql -f query='
            mutation($projectId: ID!, $contentId: ID!) {
              addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                item {
                  id
                }
              }
            }' -f projectId="$PROJECT_ID" -f contentId="$ISSUE_ID" --jq '.data.addProjectV2ItemById.item.id')

          # Status í•„ë“œ ID ì¡°íšŒ
          STATUS_FIELD_ID=$(gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            }' --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')

          # In Progress ì˜µì…˜ ID ì¡°íšŒ
          IN_PROGRESS_OPTION_ID=$(gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  field(id: "'$STATUS_FIELD_ID'") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }' --jq '.data.node.field.options[] | select(.name=="In Progress") | .id')

          # ì´ìŠˆì˜ Status ê°’ì„ In Progressë¡œ ë³€ê²½
          gh api graphql -f query='
            mutation {
              updateProjectV2ItemFieldValue(input: {
                projectId: "'$PROJECT_ID'",
                itemId: "'$ITEM_ID'",
                fieldId: "'$STATUS_FIELD_ID'",
                value: { singleSelectOptionId: "'$IN_PROGRESS_OPTION_ID'" }
              }) {
                projectV2Item {
                  id
                }
              }
            }'

          echo "âœ… ì´ìŠˆ #$ISSUE_NUMBERì˜ ìƒíƒœê°€ 'In Progress'ë¡œ ì „ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
