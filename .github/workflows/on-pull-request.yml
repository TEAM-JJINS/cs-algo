name: On Pull Request Created

on:
  pull_request:
    types: [ opened, reopened, synchronize ]

jobs:
  move-issue-to-in-review:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§ª PR ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ“ PR Title: ${{ github.event.pull_request.title }}"
          echo "ğŸŒ¿ Source Branch: ${{ github.event.pull_request.head.ref }}"

      - name: ğŸ” ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
        id: extract
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '#[0-9]+' | tr -d '#')

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜•ì‹: type#123/description"
            exit 1
          fi

          echo "ğŸ”— ì´ìŠˆ ë²ˆí˜¸: $ISSUE_NUMBER"
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: ğŸ”„ GitHub Projects ìƒíƒœë¥¼ In Reviewë¡œ ë³€ê²½
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER=${{ steps.extract.outputs.issue_number }}
          REPO=cs-algo
          OWNER=TEAM-JJINS
          PROJECT_NUMBER=1

          # 1. ì´ìŠˆ ID ì¡°íšŒ
          ISSUE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $issue: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $issue) {
                  id
                }
              }
            }' -f owner="$OWNER" -f repo="$REPO" -F issue=$ISSUE_NUMBER --jq '.data.repository.issue.id')

          if [ -z "$ISSUE_ID" ]; then
            echo "âš ï¸ ì´ìŠˆ #$ISSUE_NUMBERë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒíƒœ ì „ì´ ìƒëµ."
            exit 0
          fi

          # 2. í”„ë¡œì íŠ¸ ID ì¡°íšŒ
          PROJECT_ID=$(gh api graphql -f query='
            query {
              organization(login: "TEAM-JJINS") {
                projectV2(number: 1) {
                  id
                }
              }
            }' --jq '.data.organization.projectV2.id')

          # 3. itemId í˜ì´ì§€ë„¤ì´ì…˜ ê¸°ë°˜ ì¡°íšŒ
          ITEM_ID=""
          CURSOR="null"

          while true; do
            if [ "$CURSOR" = "null" ]; then
              QUERY_ARG='first: 100'
            else
              QUERY_ARG="first: 100, after: \"$CURSOR\""
            fi

            RESPONSE=$(gh api graphql -f query="
              query {
                organization(login: \\\"TEAM-JJINS\\\") {
                  projectV2(number: 1) {
                    items($QUERY_ARG) {
                      pageInfo {
                        endCursor
                        hasNextPage
                      }
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                          }
                        }
                      }
                    }
                  }
                }
              }
            ")

            ITEM_ID=$(echo "$RESPONSE" | jq -r --argjson issue "$ISSUE_NUMBER" '
              .data.organization.projectV2.items.nodes[]
              | select(.content.number == $issue)
              | .id
            ')

            if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then
              echo "âœ… í”„ë¡œì íŠ¸ ë‚´ ì´ìŠˆ í•­ëª© ID ë°œê²¬: $ITEM_ID"
              break
            fi

            HAS_NEXT=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage')
            if [ "$HAS_NEXT" != "true" ]; then
              break
            fi

            CURSOR=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.endCursor')
          done

          if [ -z "$ITEM_ID" ]; then
            echo "âš ï¸ ì´ìŠˆëŠ” ì¡´ì¬í•˜ì§€ë§Œ í”„ë¡œì íŠ¸ì— í¬í•¨ë˜ì–´ ìˆì§€ ì•Šì•„ ìƒíƒœ ì „ì´ë¥¼ ìƒëµí•©ë‹ˆë‹¤."
            exit 0
          fi

          # 4. Status í•„ë“œ ID ì¡°íšŒ
          STATUS_FIELD_ID=$(gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  fields(first: 20) {
                    nodes {
                      id
                      name
                    }
                  }
                }
              }
            }' --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')

          # 5. 'In Review' ì˜µì…˜ ID ì¡°íšŒ
          IN_REVIEW_OPTION_ID=$(gh api graphql -f query='
            query {
              node(id: "'$PROJECT_ID'") {
                ... on ProjectV2 {
                  field(id: "'$STATUS_FIELD_ID'") {
                    ... on ProjectV2SingleSelectField {
                      options {
                        id
                        name
                      }
                    }
                  }
                }
              }
            }' --jq '.data.node.field.options[] | select(.name=="In Review") | .id')

          # 6. ìƒíƒœ í•„ë“œ ê°’ ë³€ê²½ (In Reviewë¡œ)
          gh api graphql -f query='
            mutation {
              updateProjectV2ItemFieldValue(input: {
                projectId: "'$PROJECT_ID'",
                itemId: "'$ITEM_ID'",
                fieldId: "'$STATUS_FIELD_ID'",
                value: { singleSelectOptionId: "'$IN_REVIEW_OPTION_ID'" }
              }) {
                projectV2Item {
                  id
                }
              }
            }'

          echo "âœ… ì´ìŠˆ #$ISSUE_NUMBERì˜ ìƒíƒœê°€ 'In Review'ë¡œ ì „ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
