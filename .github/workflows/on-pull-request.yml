name: On Pull Request Created

on:
  pull_request:
    types: [ opened, reopened, synchronize ]

jobs:
  move-issue-to-in-review:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§ª PR ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ“ PR Title: ${{ github.event.pull_request.title }}"
          echo "ğŸŒ¿ Source Branch: ${{ github.event.pull_request.head.ref }}"

      - name: ğŸ” ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
        id: extract
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '#[0-9]+' | tr -d '#')
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "âŒ ë¸Œëœì¹˜ëª…ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ì‹¤íŒ¨."
            exit 1
          fi
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      - name: ğŸ”„ GitHub Projects ìƒíƒœë¥¼ In Reviewë¡œ ë³€ê²½
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ISSUE_NUMBER=${{ steps.extract.outputs.issue_number }}
          REPO=cs-algo
          OWNER=TEAM-JJINS
          PROJECT_NUMBER=1

          echo "ğŸ” ì´ìŠˆ ë²ˆí˜¸: $ISSUE_NUMBER"

          ISSUE_ID=$(gh api graphql -f query="query { repository(owner: \"$OWNER\", name: \"$REPO\") { issue(number: $ISSUE_NUMBER) { id } } }" --jq '.data.repository.issue.id')
          echo "ğŸ†” ISSUE_ID: $ISSUE_ID"
          if [ -z "$ISSUE_ID" ]; then
            echo "âš ï¸ ì´ìŠˆ ì—†ìŒ. ìƒíƒœ ì „ì´ ìƒëµ."
            exit 0
          fi

          PROJECT_ID=$(gh api graphql -f query="query { organization(login: \"$OWNER\") { projectV2(number: $PROJECT_NUMBER) { id } } }" --jq '.data.organization.projectV2.id')
          echo "ğŸ†” PROJECT_ID: $PROJECT_ID"

          ITEM_ID=""
          CURSOR=null
          while true; do
            if [ "$CURSOR" = "null" ]; then QUERY_ARG='first: 100'; else QUERY_ARG="first: 100, after: \"$CURSOR\""; fi
            RESPONSE=$(gh api graphql -f query="query { organization(login: \"$OWNER\") { projectV2(number: $PROJECT_NUMBER) { items($QUERY_ARG) { pageInfo { endCursor hasNextPage } nodes { id content { ... on Issue { number } } } } } } }")
            ITEM_ID=$(echo "$RESPONSE" | jq -r --argjson issue "$ISSUE_NUMBER" '.data.organization.projectV2.items.nodes[] | select(.content.number == $issue) | .id')
            if [ -n "$ITEM_ID" ] && [ "$ITEM_ID" != "null" ]; then break; fi
            HAS_NEXT=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.hasNextPage')
            if [ "$HAS_NEXT" != "true" ]; then break; fi
            CURSOR=$(echo "$RESPONSE" | jq -r '.data.organization.projectV2.items.pageInfo.endCursor')
          done

          if [ -z "$ITEM_ID" ]; then
            echo "âš ï¸ í”„ë¡œì íŠ¸ì— í¬í•¨ë˜ì§€ ì•Šì€ ì´ìŠˆì…ë‹ˆë‹¤. ìƒíƒœ ì „ì´ ìƒëµ."
            exit 0
          fi

          STATUS_FIELD_ID=$(gh api graphql -f query="query {
            node(id: \"$PROJECT_ID\") {
              ... on ProjectV2 {
                fields(first: 20) {
                  nodes {
                    id
                    name
                  }
                }
              }
            }
          }" --jq '.data.node.fields.nodes[] | select(.name=="Status") | .id')
          echo "ğŸ“Œ STATUS_FIELD_ID: $STATUS_FIELD_ID"

          # í•„ë“œì˜ ì‹¤ì œ íƒ€ì… í™•ì¸
          FIELD_TYPE=$(gh api graphql -f query="query {
            node(id: \"$STATUS_FIELD_ID\") {
              __typename
            }
          }" --jq '.data.node.__typename')
          echo "ğŸ“Œ FIELD_TYPE: $FIELD_TYPE"

          if [ "$FIELD_TYPE" != "ProjectV2SingleSelectField" ]; then
            echo "âŒ STATUS í•„ë“œ íƒ€ì…ì´ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤: $FIELD_TYPE"
            exit 1
          fi

          IN_REVIEW_OPTION_ID=$(gh api graphql -f query="query {
            node(id: \"$STATUS_FIELD_ID\") {
              ... on ProjectV2SingleSelectField {
                options {
                  id
                  name
                }
              }
            }
          }" --jq '.data.node.options[] | select(.name=="In Review") | .id')
          echo "ğŸ“Œ IN_REVIEW_OPTION_ID: $IN_REVIEW_OPTION_ID"

          if [ -z "$IN_REVIEW_OPTION_ID" ]; then
            echo "âŒ In Review ì˜µì…˜ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

          gh api graphql -f query="mutation {
            updateProjectV2ItemFieldValue(input: {
              projectId: \"$PROJECT_ID\",
              itemId: \"$ITEM_ID\",
              fieldId: \"$STATUS_FIELD_ID\",
              value: { singleSelectOptionId: \"$IN_REVIEW_OPTION_ID\" }
            }) {
              projectV2Item { id }
            }
          }"

          echo "âœ… ìƒíƒœê°€ 'In Review'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."
